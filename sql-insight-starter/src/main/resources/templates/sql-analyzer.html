<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8" />
    <title>SQL Insight Analyzer</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" th:href="@{/css/sql-analyzer.css}" />

</head>

<body>
    <div class="container-fluid">
        <h3 class="mr-3 mb-3">SQL Insight Analyzer</h3>
        <form class="form-inline mb-3" method="get" action="/sql-analyzer">
            <label class="mr-2">Limit</label>
            <input name="limit" type="number" class="form-control mr-3" th:value="${limit}" min="1" />
            <label class="mr-2">Level</label>
            <select name="level" class="form-control mr-3">
                <option th:value="" th:selected="${level} == null || ${level} == ''">ALL</option>
                <option th:value="OK" th:selected="${level} == 'OK'">OK</option>
                <option th:value="WARN" th:selected="${level} == 'WARN'">WARN</option>
                <option th:value="CRIT" th:selected="${level} == 'CRIT'">CRIT</option>
            </select>
            <label class="mr-2">SQL ID</label>
            <input name="sqlId" type="text" class="form-control mr-3" th:value="${sqlId}" placeholder="contains..." />
            <button class="btn btn-primary mr-2" type="submit">æŸ¥è¯¢</button>
            <button class="btn btn-outline-info mr-2" type="button" id="refreshBtn">
                <span>ğŸ”„</span> åˆ·æ–°
            </button>
            <div class="btn-group mr-2" id="exportDropdown">
                <button class="btn btn-outline-success dropdown-toggle" type="button" id="exportBtn"
                    data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    <span>ğŸ“¥</span> å¯¼å‡º
                </button>
                <div class="dropdown-menu" aria-labelledby="exportBtn">
                    <a class="dropdown-item" href="#" data-export="csv">
                        <span>ğŸ“„</span> CSVæ ¼å¼
                    </a>
                    <a class="dropdown-item" href="#" data-export="json">
                        <span>ğŸ“‹</span> JSONæ ¼å¼
                    </a>
                    <a class="dropdown-item" href="#" data-export="excel">
                        <span>ğŸ“Š</span> Excelæ ¼å¼
                    </a>
                </div>
            </div>
        </form>
        <table class="table table-sm table-striped table-bordered">
            <thead class="thead-light">
                <tr>
                    <th>æ—¶é—´</th>
                    <th>SQL ID</th>
                    <th>æ•°æ®åº“</th>
                    <th>DBç‰ˆæœ¬</th>
                    <th>ç­‰çº§</th>
                    <th>åˆ†æ•°</th>
                    <th>æ€»è€—æ—¶(ms)</th>
                    <th>ä¸šåŠ¡SQLè€—æ—¶(ms)</th>
                    <th>SQL</th>
                    <th>EXPLAIN SQL</th>
                    <th>æ˜ç»†</th>
                </tr>
            </thead>
            <tbody>
                <tr th:each="r : ${records}">
                    <td th:text="${#dates.format(new java.util.Date(r.ts), 'yyyy-MM-dd HH:mm:ss')}"></td>
                    <td th:text="${r.dto.sqlId}"></td>
                    <td th:text="${r.dto.dbProductName}"></td>
                    <td th:text="${r.dto.dbVersion}"></td>
                    <td th:text="${r.dto.scoreResult != null ? r.dto.scoreResult.level : ''}"></td>
                    <td th:text="${r.dto.scoreResult != null ? r.dto.scoreResult.score : ''}"></td>
                    <td th:text="${r.dto.costMs}"></td>
                    <td th:text="${r.dto.bizCostMs}"></td>
                    <td>
                        <pre th:text="${r.dto.sql}"></pre>
                    </td>
                    <td>
                        <pre th:text="${r.dto.explainSql}"></pre>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-secondary view-detail" data-toggle="modal"
                            data-target="#detailModal"
                            th:attr="data-detailjson=${#strings.escapeJson(#objectMapper.writeValueAsString(r.dto))}">æŸ¥çœ‹</button>
                    </td>
                </tr>
            </tbody>
        </table>
        <nav>
            <ul class="pagination">
                <li class="page-item" th:classappend="${page} <= 1 ? 'disabled'">
                    <a class="page-link"
                        th:href="@{/sql-analyzer(page=${page-1},size=${size},limit=${limit},level=${level},sqlId=${sqlId})}">ä¸Šä¸€é¡µ</a>
                </li>
                <li class="page-item disabled"><span class="page-link" th:text="${page} + '/' + ${totalPages}"></span>
                </li>
                <li class="page-item" th:classappend="${page} >= ${totalPages} ? 'disabled'">
                    <a class="page-link"
                        th:href="@{/sql-analyzer(page=${page+1},size=${size},limit=${limit},level=${level},sqlId=${sqlId})}">ä¸‹ä¸€é¡µ</a>
                </li>
            </ul>
        </nav>
        <p class="text-muted">å¯ç”¨é…ç½®ï¼šsql.analysis.ui-enabled=true</p>
    </div>
    <div class="modal fade" id="detailModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">åˆ†ææ˜ç»† JSON</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <pre id="detailBody" style="white-space:pre-wrap"></pre>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- SheetJS for Excel export -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script th:src="@{/js/sql-analyzer.js}"></script>
    <script>
        $(function () {
            $('.view-detail').on('click', function () {
                var data = $(this).attr('data-detailjson');
                $('#detailBody').text(JSON.stringify(JSON.parse(data), null, 2));
            });
        });
    </script>
</body>

</html>